env:
  REPOSITORY_ROOT: "us-docker.pkg.dev/tc-platform-artifacts/theconversation"
  REPOSITORY_LIBRARY: "${REPOSITORY_ROOT}/library"
  IMAGE_VERSION: "1.5.2-r4"

steps:
  - label: ":docker: Build"
    plugins:
      docker-compose#v5.2.0:
        build: library
        push:
          - "library:$REPOSITORY_LIBRARY:build-$BUILDKITE_BUILD_NUMBER"

  - wait

  - label: ":eslint: Lint"
    command: npm run lint
    plugins:
      docker-compose#v5.2.0:
        run: library

  - label: ":npm: Test"
    command: npm run test
    plugins:
      docker-compose#v5.2.0:
        run: library

  - block: "Tag"
    branches: main

  - label: ":docker: Tag"
    branches: main
    plugins:
      docker-compose#v5.2.0:
        push:
          - "library:${REPOSITORY_LIBRARY}:${IMAGE_VERSION}"
